async function pageFunction(context) {
    const { $, request, log } = context;
    const url = request.url;

    // Testing if we are on the list page or the detail page
    if (url.startsWith('https://onlineradiobox.com/genre/pop')) {
        log.info("Processing list page: " + url);

        $('.stations__station__title a').each(function () {
            const href = $(this).attr('href');
            if (href) {
                context.enqueueRequest({
                    url: `https://onlineradiobox.com${href}`
                });
            }
        });

        return null; // Done with list page, continue with another page from the request qeueu
    }

    // We are on the detail page
    log.info("Processing station page: " + url);

    const name = $('.station__title').text().trim();

    const genreElements = $('.station__tags li');
    const genreFields = {};

    genreElements.each(function (index) {
        const genre = $(this).text().trim();
        genreFields[`genre${index + 1}`] = genre;
    });

    const description = $('.station__description').text().trim();
    const rating = $('.subject-rating__votes__value span').text().trim();
    const review = {
        count: parseInt($('span[itemprop="reviewCount"]').text().trim(), 10)
    };

    const externalLinks = [];

    $('a[href]').each(function () {
        const href = $(this).attr('href');
        
        // Check if it's a full URL and not on onlineradiobox.com
        if (href && href.startsWith('http') && !href.includes('onlineradiobox.com')) {
            externalLinks.push(href);
        }
    });

    const website = $('a.station__reference--web[itemprop="url"]').attr('href') || 'Not found';

    const facebook = $('a.i-fb--reference[title="Facebook"]').attr('href') || 'Not found';

    const twitter = $('a.i-tw--reference[title="Twitter"]').attr('href') || 'Not found';

    const wiki = $('a.i-wiki--reference[title="Wikipedia"]').attr('href') || 'Not found';

    // Return data
    return {
        name,
        url,
        description,
        ...genreFields,
        rating,
        review,
        website,
        facebook,
        twitter,
        wiki,
        externalLinks
    };
}
